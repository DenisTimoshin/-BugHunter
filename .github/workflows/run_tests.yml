name: Run autotests

# on:
#     # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ workflow —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å GitHub
#   workflow_dispatch:
#     inputs:
#       deployment_target:
#         description: select tests to run
#         required: true
#         type: choice
#         default: all
#         options:
#           - all
on:
  push:
    branches:
      - main  # –£–∫–∞–∂–∏—Ç–µ –≤–µ—Ç–∫—É, –∫–æ—Ç–æ—Ä—É—é –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –¥–ª—è GitHub Pages (–æ–±—ã—á–Ω–æ main –∏–ª–∏ gh-pages)
  pull_request:
    branches:
      - main

jobs:
  run-tests:
    runs-on: ubuntu-latest
    name: Tests


    steps:
      # –®–∞–≥ 1: –í—ã–ø–æ–ª–Ω—è–µ–º checkout –∫–æ–¥–∞ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v4

      # –®–∞–≥ 2: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10' # –£–∫–∞–∂–∏—Ç–µ –Ω—É–∂–Ω—É—é –≤–µ—Ä—Å–∏—é Python

      # –®–∞–≥ 3: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–∑ requirements.txt
      - name: Install dependencies
        run: pip install -r requirements.txt

        # –®–∞–≥ 4: –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ deployment_target
      - name: Run tests
        run: pytest -v

        # –®–∞–≥ 5: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
      - name: Send Telegram notification
        if: always() # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ç–µ—Å—Ç–æ–≤
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            MESSAGE="‚úÖ –¢–µ—Å—Ç—ã KOKOC TECH —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω—ã üèÅ"
          elif [ "${{ job.status }}" == "failure" ]; then
            MESSAGE="‚ùå –¢–µ—Å—Ç—ã KOKOC TECH –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å —Å –æ—à–∏–±–∫–æ–π üèÅ"
          else
            MESSAGE="‚èπÔ∏è –¢–µ—Å—Ç—ã KOKOC TECH –±—ã–ª–∏ –æ—Ç–º–µ–Ω–µ–Ω—ã üèÅ"
          fi
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d text="$MESSAGE"
